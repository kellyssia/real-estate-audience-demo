<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real Estate Audience</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --border:rgba(255,255,255,.14);
      --accent:#7c3aed;
      --accent2:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(124,58,237,0.25), transparent 50%),
        radial-gradient(900px 500px at 80% 20%, rgba(34,197,94,0.18), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px}
    header{
      padding:24px 0 14px;
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(8px);
    }
    .hero{
      display:flex;flex-wrap:wrap;gap:14px;align-items:flex-end;justify-content:space-between;
    }
    .hero h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .hero p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      max-width:72ch;
    }
    .pills{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .pill{
      padding:8px 10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.05);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    main{padding:18px 0 44px}
    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,0.04);
      border-radius:18px;
      overflow:hidden;
      margin-top:14px;
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      background:rgba(255,255,255,0.03);
    }
    .panelHead strong{font-size:14px}
    .grid{
      display:grid;
      gap:12px;
      padding:14px;
      grid-template-columns:repeat(4,minmax(0,1fr));
    }
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    .tile{
      border:1px solid var(--border);
      background:linear-gradient(180deg,var(--card),rgba(255,255,255,0.03));
      border-radius:16px;
      overflow:hidden;
      cursor:pointer;
      padding:0;
      text-align:left;
      color:var(--text);
      transition:transform 120ms ease,border-color 120ms ease,background 120ms ease;
      display:block;
      width:100%;
    }
    .tile:hover{
      transform:translateY(-2px);
      border-color:rgba(124,58,237,0.55);
      background:linear-gradient(180deg,var(--card2),rgba(255,255,255,0.03));
    }
    .thumb{
      height:120px;
      width:100%;
      object-fit:cover;
      background:rgba(255,255,255,.06);
      display:block;
    }
    .tileBody{padding:12px 12px 14px}
    .tileTitle{margin:0 0 6px;font-weight:800;font-size:14px}
    .tileMeta{margin:0;color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{
      flex:1 1 240px;
      display:flex;
      flex-direction:column;
      gap:6px;
      margin:10px 0;
    }
    input{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.06);
      color:var(--text);
      outline:none;
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      background:rgba(124,58,237,0.95);
      color:white;
      font-weight:800;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .subnote{color:var(--muted);font-size:12px;margin:8px 0 0}
    .preview{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:10px;
    }
    .avatar{
      width:56px;height:56px;border-radius:14px;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.16);
      object-fit:cover;
      display:none;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.65);
      border:1px solid rgba(255,255,255,0.18);
      color:rgba(255,255,255,0.92);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity 180ms ease;
      max-width:92vw;
      text-align:center;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="hero">
        <div>
          <h1>Real Estate Audience</h1>
          <p>Register (optional photo), then make your selections. Your choices stream live to Mission Control.</p>
        </div>
        <div class="pills">
          <div class="pill" id="wsStatus">WS: connecting…</div>
          <div class="pill" id="sessionPill">Session: —</div>
          <div class="pill" id="visitorPill">Visitor: —</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">

      <!-- REGISTRATION -->
      <div class="panel" id="regPanel">
        <div class="panelHead">
          <strong>Step 0: Registration (optional)</strong>
          <span class="pill">Upload or take a photo</span>
        </div>
        <div style="padding:14px;">
          <div class="row">
            <div class="field">
              <label for="regName">Name</label>
              <input id="regName" type="text" placeholder="First name" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Upload photo</label>
              <input id="photoUpload" type="file" accept="image/*" />
            </div>
            <div class="field">
              <label>Take photo (camera)</label>
              <input id="photoCapture" type="file" accept="image/*" capture="user" />
            </div>
          </div>

          <div class="preview">
            <img id="photoPreview" class="avatar" alt="Preview" />
            <div>
              <button class="btn" id="continueBtn" type="button">Continue</button>
              <div class="subnote" id="photoNote">Photo is optional. If you add one, it will be used only for this demo session.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP: LOCATION -->
      <div class="panel">
        <div class="panelHead">
          <strong>Step 1: Location</strong>
          <span class="pill">Tap a tile</span>
        </div>
        <div class="grid">
          <button class="tile" type="button"
            data-ws-event="selection"
            data-step="location"
            data-choice-key="sobha-hartland"
            data-choice-label="Sobha Hartland"
            data-choice-image="/assets/locations/sobha-hartland.jpg">
            <img class="thumb" src="/assets/locations/sobha-hartland.jpg" alt="Sobha Hartland" onerror="this.style.display='none'"/>
            <div class="tileBody">
              <p class="tileTitle">Sobha Hartland</p>
              <p class="tileMeta">Waterfront • Connected living</p>
            </div>
          </button>

          <button class="tile" type="button"
            data-ws-event="selection"
            data-step="location"
            data-choice-key="dubai-marina"
            data-choice-label="Dubai Marina"
            data-choice-image="/assets/locations/dubai-marina.jpg">
            <img class="thumb" src="/assets/locations/dubai-marina.jpg" alt="Dubai Marina" onerror="this.style.display='none'"/>
            <div class="tileBody">
              <p class="tileTitle">Dubai Marina</p>
              <p class="tileMeta">Lifestyle • Views</p>
            </div>
          </button>

          <button class="tile" type="button"
            data-ws-event="selection"
            data-step="location"
            data-choice-key="downtown-dubai"
            data-choice-label="Downtown Dubai"
            data-choice-image="/assets/locations/downtown-dubai.jpg">
            <img class="thumb" src="/assets/locations/downtown-dubai.jpg" alt="Downtown Dubai" onerror="this.style.display='none'"/>
            <div class="tileBody">
              <p class="tileTitle">Downtown Dubai</p>
              <p class="tileMeta">Iconic • Central</p>
            </div>
          </button>

          <button class="tile" type="button"
            data-ws-event="selection"
            data-step="location"
            data-choice-key="palm-jumeirah"
            data-choice-label="Palm Jumeirah"
            data-choice-image="/assets/locations/palm-jumeirah.jpg">
            <img class="thumb" src="/assets/locations/palm-jumeirah.jpg" alt="Palm Jumeirah" onerror="this.style.display='none'"/>
            <div class="tileBody">
              <p class="tileTitle">Palm Jumeirah</p>
              <p class="tileMeta">Luxury • Beach</p>
            </div>
          </button>
        </div>
      </div>

      <!-- STEP: PROPERTY TYPE -->
      <div class="panel">
        <div class="panelHead">
          <strong>Step 2: Property Type</strong>
          <span class="pill">Tap a tile</span>
        </div>
        <div class="grid">
          <button class="tile" type="button"
            data-ws-event="selection"
            data-step="propertyType"
            data-choice-key="apartment"
            data-choice-label="Apartment"
            data-choice-image="/assets/property/apartment.jpg">
            <img class="thumb" src="/assets/property/apartment.jpg" alt="Apartment" onerror="this.style.display='none'"/>
            <div class="tileBody">
              <p class="tileTitle">Apartment</p>
              <p class="tileMeta">Modern • Low maintenance</p>
            </div>
          </button>

          <button class="tile" type="button"
            data-ws-event="selection"
            data-step="propertyType"
            data-choice-key="townhouse"
            data-choice-label="Townhouse"
            data-choice-image="/assets/property/townhouse.jpg">
            <img class="thumb" src="/assets/property/townhouse.jpg" alt="Townhouse" onerror="this.style.display='none'"/>
            <div class="tileBody">
              <p class="tileTitle">Townhouse</p>
              <p class="tileMeta">Space • Community</p>
            </div>
          </button>

          <button class="tile" type="button"
            data-ws-event="selection"
            data-step="propertyType"
            data-choice-key="villa"
            data-choice-label="Villa"
            data-choice-image="/assets/property/villa.jpg">
            <img class="thumb" src="/assets/property/villa.jpg" alt="Villa" onerror="this.style.display='none'"/>
            <div class="tileBody">
              <p class="tileTitle">Villa</p>
              <p class="tileMeta">Privacy • Premium</p>
            </div>
          </button>

          <button class="tile" type="button"
            data-ws-event="selection"
            data-step="propertyType"
            data-choice-key="penthouse"
            data-choice-label="Penthouse"
            data-choice-image="/assets/property/penthouse.jpg">
            <img class="thumb" src="/assets/property/penthouse.jpg" alt="Penthouse" onerror="this.style.display='none'"/>
            <div class="tileBody">
              <p class="tileTitle">Penthouse</p>
              <p class="tileMeta">Views • Prestige</p>
            </div>
          </button>
        </div>
      </div>

    </div>
  </main>

  <div class="toast" id="toast"></div>

  <!-- ✅ REAL relay WebSocket URL -->
  <script>
    window.__RELAY_WSS_URL__ = "wss://real-estate-live-demo.onrender.com";
  </script>

  <!-- ✅ Demo session + visitor -->
  <script>
    const sessionId = "demo-" + new Date().toISOString();
    const visitorId = localStorage.getItem("visitorId") || crypto.randomUUID();
    localStorage.setItem("visitorId", visitorId);

    document.getElementById("sessionPill").textContent = "Session: " + sessionId.split("T")[0];
    document.getElementById("visitorPill").textContent = "Visitor: " + visitorId.slice(0, 8);
  </script>

  <!-- ✅ WS client (must exist at /ws-client.js) -->
  <script src="/ws-client.js"></script>

  <script>
    const toastEl = document.getElementById("toast");
    const wsStatusEl = document.getElementById("wsStatus");
    const previewImg = document.getElementById("photoPreview");
    let photoUrl = null;

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1400);
    }

    function refreshWsStatus(){
      const st = window.RealEstateWS?.status?.();
      if (!st) return;
      const rs = st.readyState;
      const label =
        rs === 0 ? "connecting…" :
        rs === 1 ? "OPEN ✅" :
        rs === 2 ? "closing…" :
        rs === 3 ? "CLOSED ❌" : String(rs);
      wsStatusEl.textContent = "WS: " + label;
    }
    setInterval(refreshWsStatus, 600);
    refreshWsStatus();

    async function uploadPhoto(file){
      const form = new FormData();
      form.append("photo", file);
      form.append("sessionId", sessionId);
      form.append("visitorId", visitorId);

      // Upload goes to relay over HTTPS
      const res = await fetch("https://real-estate-live-demo.onrender.com/upload", {
        method: "POST",
        body: form
      });
      if (!res.ok) throw new Error("Upload failed: " + res.status);
      const data = await res.json();
      return data.photoUrl;
    }

    async function handlePhotoSelect(e){
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      previewImg.src = URL.createObjectURL(file);
      previewImg.style.display = "block";
      toast("Uploading photo…");

      try{
        photoUrl = await uploadPhoto(file);
        toast("Photo ready ✅");
      }catch(err){
        console.error(err);
        toast("Photo upload failed");
        photoUrl = null;
      }
    }

    document.getElementById("photoUpload").addEventListener("change", handlePhotoSelect);
    document.getElementById("photoCapture").addEventListener("change", handlePhotoSelect);

    document.getElementById("continueBtn").addEventListener("click", () => {
      const name = (document.getElementById("regName").value || "Guest").trim();

      window.RealEstateWS?.sendSelection?.({
        eventType: "registration",
        sessionId,
        visitorId,
        name,
        photoUrl
      });

      document.getElementById("regPanel").style.display = "none";
      toast("Registered ✅");
    });

    // Global click -> WS (only on elements with data-ws-event)
    document.addEventListener("click", (e) => {
      const el = e.target.closest("[data-ws-event]");
      if (!el) return;

      const payload = {
        eventType: el.dataset.wsEvent,
        sessionId,
        visitorId,
        photoUrl,
        step: el.dataset.step,
        choiceKey: el.dataset.choiceKey,
        choiceLabel: el.dataset.choiceLabel,
        choiceImage: el.dataset.choiceImage
      };

      const sent = window.RealEstateWS?.sendSelection?.(payload);
      if (sent) toast(`Sent: ${payload.choiceLabel}`);
      else toast("WS not connected yet");
    });
  </script>
</body>
</html>
